<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>A-Frame No Component Version</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
</head>

<body>
  <a-scene cursor="rayOrigin: mouse">
    <!-- draggable属性は削除し、IDで特定します -->
    <a-box id="targetBox" position="0 1 -3" color="red"></a-box>

    <a-entity id="ctlR" laser-controls="hand: right" raycaster="lineColor: red;"></a-entity>
  </a-scene>

  <script>
    // ページ読み込み完了後に実行
    document.addEventListener('DOMContentLoaded', () => {
      
      // 操作対象の箱を取得
      const targetBox = document.getElementById('targetBox');
      
      // 状態管理用の変数
      let isDragging = false;
      let dragDistance = 0;
      let activeRaycaster = null;

      // --- 1. マウスダウン（ドラッグ開始） ---
      targetBox.addEventListener('mousedown', (evt) => {
        // 交差判定（クリック位置の情報）があるか確認
        if (evt.detail.intersection) {
          isDragging = true;
          // カメラからオブジェクトまでの距離を保存
          dragDistance = evt.detail.intersection.distance;
          // クリックした主体（マウスやコントローラー）のRaycaster(光線)を取得
          activeRaycaster = evt.detail.cursorEl.components.raycaster.raycaster;
        }
      });

      // --- 2. マウスアップ（ドラッグ終了） ---
      window.addEventListener('mouseup', () => {
        isDragging = false;
        activeRaycaster = null;
      });

      // --- 3. メインループ（tickの代わり） ---
      function animate() {
        // 次のフレーム描画時にまたこの関数を呼ぶ（ループ作成）
        requestAnimationFrame(animate);

        // ドラッグ中でなければ何もしない
        if (!isDragging || !activeRaycaster) return;

        // THREE.jsの機能を使って計算
        // Ray(光線)の原点と向きを取得
        const direction = activeRaycaster.ray.direction.clone();
        const origin = activeRaycaster.ray.origin.clone();

        // 計算: 新しい位置 = 原点 + (向き × 距離)
        const newPosition = origin.add(direction.multiplyScalar(dragDistance));

        // 箱の位置を直接更新
        targetBox.object3D.position.copy(newPosition);
      }

      // ループを開始
      animate();
    });
  </script>
</body>

</html>