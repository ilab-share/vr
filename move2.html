<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>A-Frame Selectable Object with jQuery</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <a-scene cursor="rayOrigin: mouse">
    <a-box id="box1" position="0 1 -3" color="red" draggable></a-box>

    <a-entity id="ctlR" laser-controls="hand: right" raycaster="lineColor: red;"></a-entity>
  </a-scene>

  <script>
    // ドラッグ移動用のコンポーネントを定義
    AFRAME.registerComponent('draggable', {
      init: function () {
        this.isDragging = false;
        this.distance = 0;
        this.raycaster = null;

        this.onMouseDown = this.onMouseDown.bind(this);
        this.onMouseUp = this.onMouseUp.bind(this);

        this.el.addEventListener('mousedown', this.onMouseDown);
        // マウスアップはウィンドウ全体で監視（オブジェクト外で離した場合も考慮）
        window.addEventListener('mouseup', this.onMouseUp);
      },

      onMouseDown: function (evt) {
        // 交差情報がある場合のみドラッグ開始
        if (evt.detail.intersection) {
          this.isDragging = true;
          this.distance = evt.detail.intersection.distance;
          // イベント発生元のカーソル（マウスまたはコントローラー）のRaycasterを取得
          this.raycaster = evt.detail.cursorEl.components.raycaster.raycaster;
        }
      },

      onMouseUp: function () {
        this.isDragging = false;
        this.raycaster = null;
      },

      tick: function () {
        if (!this.isDragging || !this.raycaster) return;

        // レイキャスターの原点と方向を取得
        var direction = this.raycaster.ray.direction.clone();
        var origin = this.raycaster.ray.origin.clone();

        // クリックした時の距離を維持して新しい位置を計算
        var newPosition = origin.add(direction.multiplyScalar(this.distance));
        this.el.object3D.position.copy(newPosition);
      },

      remove: function () {
        this.el.removeEventListener('mousedown', this.onMouseDown);
        window.removeEventListener('mouseup', this.onMouseUp);
      }
    });

    // 既存のクリックイベント（色変更）
    $('#box1').on('click', function (e) {
      // ドラッグ直後のクリック誤爆を防ぐための簡易チェックを入れることも可能ですが、
      // 今回は単純な共存としています。
      if ($(this).attr('color') == 'red') {
        $(this).attr('color', 'yellow');
      } else {
        $(this).attr('color', 'red');
      }
    });
  </script>
</body>

</html>