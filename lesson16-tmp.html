<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>A-Frame Confetti Shower (Slow Motion)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>

    <script>
        const V3 = THREE.Vector3;

        AFRAME.registerComponent('confetti-mover', {
            schema: {
                maxAge: { type: 'number', default: 30 }, 
            },

            init: function () {
                const el = this.el;
                
                this.velocity = new V3(0, 0, 0);
                this.acceleration = new V3(0, 0, 0);
                this.age = 0;
                
                this.rotationSpeedX = (Math.random() - 0.5) * 30; 
                this.rotationSpeedY = (Math.random() - 0.5) * 30;
                
                this.gravity = new V3(0, -9.8 * 0.005, 0); 
                
                this.initialVelocitySpread = new V3(0.5, 0.5, 0.5);
            },

            tick: function (t, dt) {
                if (!dt) { return; }
                
                const data = this.data;
                const deltaSeconds = dt / 1000;
                this.age += deltaSeconds;

                if (this.age > data.maxAge) {
                    this.resetConfetti();
                    return;
                }

                this.acceleration.copy(this.gravity);
                this.acceleration.x += (Math.random() - 0.5) * 0.02; 
                this.acceleration.z += (Math.random() - 0.5) * 0.02;
                
                this.velocity.addScaledVector(this.acceleration, deltaSeconds);
                
                this.el.object3D.position.addScaledVector(this.velocity, deltaSeconds);
                
                const currentRotation = this.el.object3D.rotation;
                currentRotation.x += THREE.MathUtils.degToRad(this.rotationSpeedX * deltaSeconds);
                currentRotation.y += THREE.MathUtils.degToRad(this.rotationSpeedY * deltaSeconds);

                if (this.el.object3D.position.y < 0) {
                    this.resetConfetti();
                }
            },
            
            resetConfetti: function() {
                const el = this.el;
                const spawnerEl = el.parentNode;
                
                const spawnerPos = spawnerEl.object3D.position;
                const radius = spawnerEl.components['confetti-spawner'].data.spawnRadius;

                const angle = Math.random() * Math.PI * 2;
                const r = Math.sqrt(Math.random()) * radius;

                el.object3D.position.set(
                    spawnerPos.x + r * Math.cos(angle),
                    spawnerPos.y + (Math.random() * 2 - 1), 
                    spawnerPos.z + r * Math.sin(angle)
                );
                
                this.velocity.set(
                    (Math.random() - 0.5) * this.initialVelocitySpread.x,
                    (Math.random() - 0.5) * this.initialVelocitySpread.y,
                    (Math.random() - 0.5) * this.initialVelocitySpread.z
                );
                this.age = 0;
            }
        });


        AFRAME.registerComponent('confetti-spawner', {
            schema: {
                count: { type: 'number', default: 1000 },
                spawnRadius: { type: 'number', default: 4 },
                // 新しいスキーマ：紙吹雪の最小・最大サイズ
                minSize: { type: 'number', default: 0.05 },
                maxSize: { type: 'number', default: 0.2 },
            },

            init: function () {
                const data = this.data;
                const container = this.el;
                
                const mixin = document.getElementById('confetti-mixin');
                if (!mixin) {
                    console.error("Confetti Mixin not found in assets!");
                    return;
                }

                for (let i = 0; i < data.count; i++) {
                    const confetti = document.createElement('a-entity');
                    confetti.setAttribute('mixin', 'confetti-mixin');
                    
                    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    confetti.setAttribute('material', 'color', randomColor);

                    // 紙吹雪のサイズをランダムに設定
                    const size = data.minSize + (Math.random() * (data.maxSize - data.minSize));
                    const aspectRatio = 0.5 + Math.random(); // 0.5から1.5の間でアスペクト比を変化
                    confetti.setAttribute('geometry', `primitive: plane; width: ${size}; height: ${size * aspectRatio}`);
                    
                    container.appendChild(confetti);
                    
                    confetti.setAttribute('confetti-mover', {});
                    
                    setTimeout(() => {
                        const mover = confetti.components['confetti-mover'];
                        if (mover) {
                            mover.resetConfetti();
                        }
                    }, 50); 
                }
            }
        });

    </script>


    <a-scene 
        background="color: #111"
        renderer="
            colorManagement: true; 
            physicallyCorrectLights: true;
        "
    >
        <a-assets>
            <a-mixin 
                id="confetti-mixin" 
                material="shader: standard; side: double; roughness: 0.5"
                confetti-mover="maxAge: 30"
            ></a-mixin>
        </a-assets>

        <!-- カメラとライト -->
        <a-entity camera position="0 4 5"></a-entity>
        <a-light type="ambient" color="#BBB"></a-light>
        <a-light type="directional" position="0 5 5" intensity="0.6"></a-light>

        <!-- 地面 -->
        <a-box position="0 -0.05 0" width="10" height="0.1" depth="10" color="#333" roughness="0.8"></a-box>

        <!-- 紙吹雪の発生源（スポナー） - positionを0 4 0に変更 -->
        <a-entity 
            position="0 4 0" 
            confetti-spawner="count: 1000; spawnRadius: 4; minSize: 0.05; maxSize: 0.2"
        >
        </a-entity>

    </a-scene>
</body>
</html>



