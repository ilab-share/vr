<!DOCTYPE html>
<html>
<head>
    <!-- 1. UTF-8 メタタグを追加 -->
    <meta charset="UTF-8">
    <title>A-Frame Confetti Shower (Slow Motion)</title>
    <!-- A-Frame本体のみを使用 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>

    <script>
        const V3 = THREE.Vector3;

        /**
         * Confetti Mover コンポーネント
         * - 各紙吹雪の動き（重力と風）をシミュレーションします。
         */
        AFRAME.registerComponent('confetti-mover', {
            schema: {
                // 3. 最大生存時間を長く (10秒から20秒へ)
                maxAge: { type: 'number', default: 20 }, 
            },

            init: function () {
                const el = this.el;
                
                this.velocity = new V3(0, 0, 0);
                this.acceleration = new V3(0, 0, 0);
                this.age = 0;
                
                // 回転速度（ひらひら舞う効果）を少し遅く調整
                this.rotationSpeedX = (Math.random() - 0.5) * 30; 
                this.rotationSpeedY = (Math.random() - 0.5) * 30;
                
                // 2. 重力を大幅に弱くする (0.1 -> 0.02)
                this.gravity = new V3(0, -9.8 * 0.02, 0); 
                
                // 初期のランダムな水平方向の速度を与える
                this.initialVelocitySpread = new V3(0.5, 0.5, 0.5);
            },

            tick: function (t, dt) {
                if (!dt) { return; }
                
                const data = this.data;
                const deltaSeconds = dt / 1000;
                this.age += deltaSeconds;

                // 寿命チェック
                if (this.age > data.maxAge) {
                    this.resetConfetti();
                    return;
                }

                // 1. 加速度の計算 (重力 + 軽い風のランダム性)
                this.acceleration.copy(this.gravity);
                this.acceleration.x += (Math.random() - 0.5) * 0.05; // 風を弱める
                this.acceleration.z += (Math.random() - 0.5) * 0.05;
                
                // 2. 速度の更新 (V = V0 + A * t)
                this.velocity.addScaledVector(this.acceleration, deltaSeconds);
                
                // 3. 位置の更新 (P = P0 + V * t)
                this.el.object3D.position.addScaledVector(this.velocity, deltaSeconds);
                
                // 4. 回転の更新 (ひらひら効果)
                const currentRotation = this.el.object3D.rotation;
                currentRotation.x += THREE.MathUtils.degToRad(this.rotationSpeedX * deltaSeconds);
                currentRotation.y += THREE.MathUtils.degToRad(this.rotationSpeedY * deltaSeconds);

                // 地面より下に落ちたらリセット
                if (this.el.object3D.position.y < 0) {
                    this.resetConfetti();
                }
            },
            
            // 紙吹雪を上空にリセットする関数
            resetConfetti: function() {
                const el = this.el;
                const spawnerEl = el.parentNode;
                
                const spawnerPos = spawnerEl.object3D.position;
                const radius = spawnerEl.components['confetti-spawner'].data.spawnRadius;

                // ランダムな水平位置
                const angle = Math.random() * Math.PI * 2;
                const r = Math.sqrt(Math.random()) * radius;

                el.object3D.position.set(
                    spawnerPos.x + r * Math.cos(angle),
                    // Y座標にランダムなばらつきを持たせることで、同時に落下開始するのを防ぐ
                    spawnerPos.y + (Math.random() * 2 - 1), 
                    spawnerPos.z + r * Math.sin(angle)
                );
                
                // 初期速度にわずかなばらつきを持たせる
                this.velocity.set(
                    (Math.random() - 0.5) * this.initialVelocitySpread.x,
                    (Math.random() - 0.5) * this.initialVelocitySpread.y,
                    (Math.random() - 0.5) * this.initialVelocitySpread.z
                );
                this.age = 0;
            }
        });


        /**
         * Confetti Spawner コンポーネント
         */
        AFRAME.registerComponent('confetti-spawner', {
            schema: {
                count: { type: 'number', default: 1000 },
                spawnRadius: { type: 'number', default: 4 },
            },

            init: function () {
                const data = this.data;
                const container = this.el;
                
                const mixin = document.getElementById('confetti-mixin');
                if (!mixin) {
                    console.error("Confetti Mixin not found in assets!");
                    return;
                }

                for (let i = 0; i < data.count; i++) {
                    const confetti = document.createElement('a-entity');
                    confetti.setAttribute('mixin', 'confetti-mixin');
                    
                    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    confetti.setAttribute('material', 'color', randomColor);
                    
                    container.appendChild(confetti);
                    
                    confetti.setAttribute('confetti-mover', {});
                    
                    // 初期化が完了してからリセット関数を呼び出し
                    setTimeout(() => {
                        const mover = confetti.components['confetti-mover'];
                        if (mover) {
                            mover.resetConfetti();
                        }
                    }, 50); 
                }
            }
        });

    </script>


    <a-scene 
        background="color: #111"
        renderer="
            colorManagement: true; 
            physicallyCorrectLights: true;
        "
    >
        <a-assets>
            <a-mixin 
                id="confetti-mixin" 
                geometry="primitive: plane; width: 0.1; height: 0.15" 
                material="shader: standard; side: double; roughness: 0.5"
                confetti-mover="maxAge: 20"
            ></a-mixin>
        </a-assets>

        <!-- カメラとライト -->
        <a-entity camera position="0 2 5"></a-entity>
        <a-light type="ambient" color="#BBB"></a-light>
        <a-light type="directional" position="0 5 5" intensity="0.6"></a-light>

        <!-- 地面 -->
        <a-box position="0 -0.05 0" width="10" height="0.1" depth="10" color="#333" roughness="0.8"></a-box>

        <!-- 紙吹雪の発生源（スポナー） -->
        <a-entity 
            position="0 8 0" 
            confetti-spawner="count: 1000; spawnRadius: 4"
        >
        </a-entity>

    </a-scene>
</body>
</html>